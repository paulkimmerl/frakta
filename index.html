<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Fraktal mit Tiefe</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; width: 100vw; height: 100vh; }
  </style>
</head>
<body>
<canvas id="glcanvas"></canvas>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

const canvas = document.getElementById('glcanvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);

const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0, 0, 4);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.1;
controls.rotateSpeed = 0.5;
controls.zoomSpeed = 0.5;
controls.minDistance = 0.5;
controls.maxDistance = 10;

const uniforms = {
  iTime: { value: 0 },
  resolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) }
};

const material = new THREE.ShaderMaterial({
  uniforms,
  vertexShader: `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = vec4( position, 1.0 );
    }
  `,
  fragmentShader: `
    precision highp float;
    varying vec2 vUv;
    uniform float iTime;
    uniform vec2 resolution;

    float mandelbulb(vec3 p) {
      vec3 z = p;
      float dr = 1.0;
      float r = 0.0;
      const int ITER = 8;
      const float power = 8.0;

      for (int i = 0; i < ITER; i++) {
        r = length(z);
        if (r > 2.0) break;
        float theta = acos(z.z / r);
        float phi = atan(z.y, z.x);
        dr = pow(r, power - 1.0) * power * dr + 1.0;
        float zr = pow(r, power);
        theta *= power;
        phi *= power;
        z = zr * vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta)) + p;
      }
      return 0.5 * log(r) * r / dr;
    }

    vec3 getNormal(vec3 p) {
      float eps = 0.001;
      return normalize(vec3(
        mandelbulb(p + vec3(eps,0,0)) - mandelbulb(p - vec3(eps,0,0)),
        mandelbulb(p + vec3(0,eps,0)) - mandelbulb(p - vec3(0,eps,0)),
        mandelbulb(p + vec3(0,0,eps)) - mandelbulb(p - vec3(0,0,eps))
      ));
    }

    vec3 rayDirection(float fov, vec2 size, vec2 fragCoord) {
      vec2 xy = fragCoord - size / 2.0;
      float z = size.y / tan(radians(fov) / 2.0);
      return normalize(vec3(xy, -z));
    }

    float raymarch(vec3 ro, vec3 rd) {
      float t = 0.0;
      for (int i = 0; i < 100; i++) {
        vec3 p = ro + rd * t;
        float d = mandelbulb(p);
        if (d < 0.001) return t;
        if (t > 20.0) break;
        t += d;
      }
      return -1.0;
    }

    void main() {
      vec2 uv = vUv * resolution;
      vec3 ro = vec3(0.0, 0.0, 4.0);
      vec3 rd = rayDirection(60.0, resolution, uv);

      float dist = raymarch(ro, rd);
      vec3 col = vec3(0.0);

      if (dist > 0.0) {
        vec3 pos = ro + rd * dist;
        vec3 normal = getNormal(pos);
        vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));
        float diff = clamp(dot(normal, lightDir), 0.0, 1.0);
        float fresnel = pow(1.0 - dot(normal, -rd), 3.0);
        col = vec3(0.3, 0.5, 0.7) * diff + fresnel * 0.8;
      }

      gl_FragColor = vec4(col, 1.0);
    }
  `
});

const geometry = new THREE.PlaneGeometry(2, 2);
const mesh = new THREE.Mesh(geometry, material);
scene.add(mesh);

function animate(t) {
  uniforms.iTime.value = t * 0.001;
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
animate();

window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight);
  uniforms.resolution.value.set(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
});
</script>
</body>
</html>
